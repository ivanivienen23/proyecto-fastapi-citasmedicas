name: CI/CD Pipeline de Citas

# Disparador: Se ejecuta en cada 'push' a las ramas main o master
on:
  push:
    branches: [ main, master ]

# Permisos necesarios para que el Job pueda escribir en el registro de paquetes
permissions:
  contents: read
  packages: write

jobs:
  # ----- Job 1: Pruebas y Calidad de Código -----
  test-and-lint:
    name: Test, Lint y Format Check
    runs-on: ubuntu-latest # Usar el runner más reciente de Ubuntu

    steps:
      # 1. Descargar el código del repositorio
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Configurar el entorno de Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip' # Activar cache para las dependencias

      # 3. Instalar las dependencias
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. Ejecutar Flake8 (Linter)
      # Comprueba si hay errores de estilo o código (ej. variables no usadas)
      - name: Lint with flake8
        run: |
          # --count: Muestra el total de errores
          # --select=E9,F63,F7,F82: Reporta solo estos errores (Errores, undefined name, etc)
          # --show-source: Muestra la línea de código
          # --statistics: Muestra conteo de errores
          flake8 app tests --count --select=E9,F63,F7,F82 --show-source --statistics

      # 5. Ejecutar Black (Formatter Check)
      # Comprueba si el código está formateado según las reglas de Black
      - name: Format check with black
        run: |
          black app tests --check

      # 6. Ejecutar Pytest (Pruebas)
      - name: Run tests with pytest
        run: |
          pytest

  # ----- Job 2: Construcción y Publicación de Docker -----
  build-and-push-docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    
    # Dependencia: Este job solo se ejecuta si 'test-and-lint' fue exitoso
    needs: test-and-lint

    steps:
      # 1. Descargar el código
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Iniciar sesión en GitHub Container Registry (GHCR)
      # Usa el token automático de GitHub Actions
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }} # El usuario que disparó el workflow
          password: ${{ secrets.GITHUB_TOKEN }} # Secreto automático

      # 3. Construir la imagen Docker y publicarla (push)
      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: . # Directorio donde está el Dockerfile
          push: true # Indica que debe publicar la imagen
          # Etiqueta la imagen con el registro (ghcr.io), el nombre del repo y el hash del commit
          tags: ghcr.io/${{ github.repository }}:${{ github.sha }}